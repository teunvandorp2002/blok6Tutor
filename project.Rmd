---
title: "Genexpressie van L. plantarum WCFS1 en NC8 bij glucose en ribose"
author: "Teun van Dorp, Luc Hengeveld, Michelle Memelink"
date: "01/12/2020"
output: html_document
---
### Algemeen doel
Het doel is om te onderzoeken of er verschil is in genexpressie bij de bacterie
*Lactobacillus plantarum* WCFS1 en NC8, als deze op verschillende voedingsbodem groeit.
De twee gebruikte soorten voedingsbodem zijn glucose en ribose. Er is op 
beide bodemen twee keer een experiment uitgevoerd per stam. De resultaten die hieruit 
volgende worden gebruikt in dit onderzoek. De resultaten die door middel van 
deze code verkregen worden hebben dus betrekking op die resultaten. Uit deze 
resultaten kan uiteindelijk afgeleid worden of er verschil in genexpressie is en 
welke genen up of down gereguleerd zijn of gelijk zijn gebleven in de experessie. 
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
### Ophalen blibliotheken
De benodigde blibliotheken worden aangroepen. <br>  
Output: welke package is ingeladen.
```{r aanroepen libraries}
library(edgeR)
library(xlsx)
library(rstudioapi)
library(rafalib)
library(pathview)
```

### Bestand open en inlezen
Er kan via een pop-up een map geselecteert worden waarin het bestand staat met de 
naam "RNA-Seq-counts.txt". Vervolgens wordt er dus de naam van het bestand dat 
ingelezen moet wordt aangegeven, deze wordt tevens ingeladen. Dan wordt het
bestand ingelezen en worden alle ID's van de genen eruit gehaald. Ook wordt erin 
een andere vector de namen opgeslagen van de verschillende experimenten, dit zijn 
de kolomnamen. 
```{r aanmaken}
fDir <- selectDirectory(caption = "Select Directory")
fName <- "/RNA-Seq-counts.txt"
cnts <- read.delim(paste0(fDir,fName), comment.char="#")
row.names(cnts) <- cnts[,"ID"]
exp <- c("WCFS1.glc", "WCFS1.glc", "WCFS1.rib", "WCFS1.rib", "NC8.glc", "NC8.glc", "NC8.rib", "NC8.rib")
```

### DGElist aanmaken
Er wordt een DGElist gemaakt, door gebruik te maken van EdgeR. Het is een lijst 
welke de genen bevat met de counts die geanaylseerd moeten worden. De aangemaakt 
vector welke de kolomnamen bevat wordt meegegeven voor het maken ven de DGElist.
<br>
Output: als eerst worden de groepen aangegeven en de vier niveau's. Vervolgens 
wrodt er van elk experiment apart een sammenvatting gegeven, deze bevat onderandere
het gemiddelde, de mediaan en de eerste en derde kwartiel. Vervolgens wordt er de
gemaakte DGElist getoont. Er wordt daarna ook per experiment verkergen 
resultaten gegeven. De tweede bevat een kolom met de naam van de experiment. 
De twee kolom bevat de algemene namen van de condties (welke voedingsbodem). 
Daarna een kolom wat die de totaal aantal counts voor elk conditie bevat. De 
laatste kolom bevat normalisatie factor waarden.  
```{r DGElist aanmaken}
group <- factor(exp)
print(group)
print(summary(cnts[,2:9]))
y <- DGEList(counts=cnts[,2:9],group=group)
print(y)
```

### Normaliseren
De waardes worden genormaliseerd. Dit wordt gedaan door het bijsnijden van de 
gemiddelde van M-waarden: verwijder de laagste en hoogste waarden.
```{r normaliseren}
y <- calcNormFactors(y, method="TMM")
```

```{r filteren low read count}
print(summary(y$counts))
print(summary(cnts[,2:9]))
firstQuartile <- c()
for(i in 2:9) {
  firstQuartile[i-1] <- unname(quantile(y$counts, .25))
}
highEnough <- y$counts > mean(firstQuartile)
keep <- rowSums(highEnough) >= 4
summary(keep)
y <- y[keep, keep.lib.sizes=FALSE]
print(y)
print(mean(firstQuartile))
```

### Controleren van data
Er wordt gekeken of de data juist. Er wordt gecontroleert of het inlezen
en normaliseren op de juiste wijze is verlopen. <br>  
Output: als eerste wordt er de samenvatting welke alle experimenten bevat getoont??
Daarna wordt er per experiment verkergen resultaten gegeven. De tweede 
bevat een kolom met de naam van de experiment. De twee kolom bevat de 
algemene namen van de condties (welke voedingsbodem). Daarna een kolom wat die
de totaal aantal counts voor elk conditie bevat. De laatste kolom 
bevat normalisatie factor waardes. 
```{r controleren van data}
print(summary(y$allecounts))
print(y$samples)
```

### Matrix aanmaken
Er wordt een matrix gemaakt. Er wordt aangegeven welke kolom welk experiment bevat. 
Vervolgens wordt er een relatie gelegt tussen conditie (welke voedingsbodem), type
stam en de experimenten. Er wordt aangegeven welke experimenten gelijk aan elkaar
zijn gekeken naar de conditie, dus een groep glucose en ribose. <br> 
Output: een matrix Met als eerste kolom de namen van de experimenten. De tweede 
kolom bevat de conditie glucose voor NC8. De derde kolom bevat de conditie ribose 
voor NC8. de Vierde kolom bevat de conditie glucose voor WCFS1 en de laatste 
kolom bevat de conditie ribose voor WCFS1. Met een één wordt aangegven dat, dat 
experiment bij die conditie en stam hoort. 
Vervolgens wordt er aangegeven hoeveel kolommen data bevatten. De kolommen met 
de condities hebben allebei een 1, dus niet alle waardes in de kolom zijn 0 in de
matrix. Als laatste wordt er voor gezorgd dat elk niveau met de basislijnniveau 
wordt gecontrasteerd.
```{r matrix aanmaken}
design <- model.matrix(~0+group, data=y$samples)
colnames(design) <- levels(y$samples$group)
print(design)
```

### Spreidingsbreedte Bepalen
Er wordt op drie verschillende manieren de spreidingsbreedte bepaald. De eerste
is de common, dit is de spreiding bepaald over alle waardes en daar het gemiddelde
van genomen. De tweede manier is om de spreiding te bepalen van het gemiddelde bij 
iedere waarde op de x-as en hier vervolgens een lijn van de maken. De derde manier
is dat er per experiment resultaat een spreiding wordt bepaald, dus per gen. 
```{r spreidingsbreedte}
y <- estimateDisp(y, design)
```

### Grafieken Maken
De twee grafieken worden aangemaakt. De eerste grafiek is een multidimensionaal 
schaaldiagram van afstanden tussen genexpressieprofielen. De experimenten zijn 
op een tweedimensionale scatterplot geplot, zodat de afstanden op de plot de 
typische log2-voudige veranderingen tussen de experimenten benaderen. De tweede
grafiek is een plot welke biologische variatiecoëfficiënt toont. De genewise 
biologische variatiecoëfficiënt (BCV) zijn uitgezet tegen de overvloed aan genen
(in log2 tellingen per miljoen). <br>
Output: in het eerste grafiek als er gekeken wordt naar de eerste dimensie, is
te zien dat zowel glucose als ribose experimenten bijna dezelfde waarde hebben. 
Echter is er een groot verschil te zien in de waarde gekeken naar glucose ten 
opzichten van ribose. Dit betekend dat er spraken is van verschillende 
genexpressie. Als er gekeken wordt naar de tweede dimensie, is te zien dat bij zowel 
de ribose experimenten als de glucose experimenten bijna dezelfde waarden hebben. 
Echter is er wel verschil zichtbaar tussen glucose en ribose, maar dit bevat een
minder groot afstand dan het verschil gekeken naar de eerste dimensie tussen 
glucose en ribose, Dus kan er met zekerheid gesteld worden dat er spraken is 
van verschil in genexpressie. Ook is te zien dan de experimenten van de stammen 
rond dezelfde waarde liggen gekeken naar de tweede dimensie. 
In de tweede grafiek zijn de verschillende spreidingswaardes 
(variatiecoëfficiënt) getoont. De x-as geeft aan hoe vaak bepaald gen is geteld. 
De y-as geeft de mate van spreiding aan. 
```{r plot}
plotMDS(y)
plotBCV(y)
```

## Fit data
Op basis van de degin matrix en de samples, wordt er een model lijn (lineaire) 
gemaakt hoe de waardes zich tot elkaar verhouden. 
```{r fit data}
fit <- glmFit(y,design)
```

## Bepaal fold change
De input is het gemaakte model. Er wordt aangegeven wat er gemeten moet worden, 
dit is het verschil in genexpressie tussen glucose en ribose bij WCFS1 en bij NC8.
Dit verschil is de fold change.Vervolgens wordt het model passende gemaakt en 
geef je het vorm. 
```{r bepalen fold change}
mcWCFS1 <- makeContrasts(exp.r=WCFS1.glc-WCFS1.rib, levels=design)
fitWCFS1 <- glmLRT(fit, contrast=mcWCFS1)
mcNC8 <- makeContrasts(exp.r=NC8.glc-NC8.rib, levels=design)
fitNC8 <- glmLRT(fit, contrast=mcNC8)
```


## Beste resultaten weergeven
ALs laatste wordt het resultaat weergegeven, welke voortkomt uit het model.Er 
komt als resultaat een tabel met alle genen en de bijbehorende waardes uit. Er
wordt per stam een tabel aangemaakt namelijk WCFS1.rib met WCFS1.glc en 
NC8.rib met NC8.glc.<br>
Output: de eerste kolom bevat de gen ID's. De tweede kolom bevat de log fold 
change waardes, dus of een gen up gereglueerd of down gereglueerd is of gelijk 
gebleven. De derde kolom bevat de verschillen in counts, dus hoe vaak gen
geteld is. De vijfde kolom bevat de p-waardes. Dit zijn de exact p-waarde 
voor differentiële expressie. De laatste kolom bevat de p-waarde aangepast 
voor meervoudige tests. 
```{r beste resultaten}
print(topTags(fitWCFS1))
print(topTags(fitNC8))
resWCFS1<-topTags(fitWCFS1, n = length(fitWCFS1$fitted.values))
resNC8<-topTags(fitNC8, n = length(fitNC8$fitted.values))
```

## Genen Clusteren
```{r clusteren}
dis_matrix <- dist(t(cnts[,2:9]), method = "euclidean")
hclust_object <- hclust(dis_matrix, method = "average")
plot(hclust_object)
```

## Filteren fold change en FDR-waarde
```{r filteren resultaten}
resWCFS1 <- data.frame(resWCFS1)
attach(resWCFS1$table)
resWCFS1 <- subset(resWCFS1, (logFC > 1 | logFC < -1) & FDR < 0.001)
resNC8 <- data.frame(resNC8)
attach(resNC8$table)
resNC8 <- subset(resNC8, (logFC > 1 | logFC < -1) & FDR < 0.001)

```

## KEGG mapper
```{r KEGG mapper}
mypathway <- "lpl00010"

logFC <- resWCFS1$logFC
names(logFC) <- row.names(resWCFS1)
pathview(gene.data = logFC, species = "lpl", pathway = mypathway,  gene.idtype = "KEGG", out.suffix = "WCFS1")

pathview(gene.data = logFC, species = "lpl", pathway = "lpl00020",  gene.idtype = "KEGG", out.suffix = "WCFS1.CytrateCycle")

pathview(gene.data = logFC, species = "lpl", pathway = "lpl00030",  gene.idtype = "KEGG", out.suffix = "WCFS1.PentosePhosphate")

pathview(gene.data = logFC, species = "lpl", pathway = "lpl00190",  gene.idtype = "KEGG", out.suffix = "WCFS1.OxidativePhosphorilation")

logFC <- resNC8$logFC
names(logFC) <- row.names(resNC8)
pathview(gene.data = logFC, species = "lpl", pathway = mypathway,  gene.idtype = "KEGG", out.suffix = "NC8")

pathview(gene.data = logFC, species = "lpl", pathway = "lpl00020",  gene.idtype = "KEGG", out.suffix = "NC8.CytrateCycle")

pathview(gene.data = logFC, species = "lpl", pathway = "lpl00030",  gene.idtype = "KEGG", out.suffix = "NC8.PentosePhosphate")

pathview(gene.data = logFC, species = "lpl", pathway = "lpl00190",  gene.idtype = "KEGG", out.suffix = "NC8.OxidativePhosphorilation")
```

## Tags toevoegen
```{r tags}
annotation = read.delim("WCFS1_anno.txt", header=TRUE, row.names = 1)
drops <- c("X","X.1","X.2","X.3", "X.4")
annotation <- annotation[ , !(names(annotation) %in% drops)]
resWCFS1 <- cbind(resWCFS1, annotation[rownames(resWCFS1),])
resNC8 <- cbind(resNC8, annotation[rownames(resNC8),])
```

## Resultaten opslaan in Excel bestand
De data van de tabellen worden opgeslagen in een excel bestand. Dit bestand
bestaat uit 2 verschillende sheets: een sheet met alle data en een ander
sheet met de beste waarden.
```{r resultaten opslaan}
write.xlsx(resWCFS1, paste0(fDir, "/foldChanges.xlsx"), sheetName = "WCFS1", col.names = T,
           row.names = T, append = F)
write.xlsx(resNC8, paste0(fDir, "/foldChanges.xlsx"), sheetName = "NC8", col.names = T,
          row.names = T, append = T)
```




```{}
glu <- c()
for (i in 1:nrow(fit$coefficients)) {
  glu[length(glu)+1] <- fit$coefficients[i,1]
  glu[length(glu)+1] <- fit$coefficients[i,3]
}
rib <- c()
for (i in 1:nrow(fit$coefficients)) {
  rib[length(rib)+1] <- fit$coefficients[i,2]
  rib[length(rib)+1] <- fit$coefficients[i,4]
}

gluRib <- matrix(data = c(glu, rib), ncol = 2)
colnames(gluRib) <- c("glu", "rib")

mcGluRib <- makeContrasts(exp.r = glu-rib, levels = design)
fitGluRib <- glmLRT(gluRib, contrast = mcGluRib)
```

